SELECT
    v.SQL_ID,
    v.START_TIME,
    v.END_TIME,
    ROUND((v.END_TIME - v.START_TIME) * 24 * 60, 2) AS duration_minutes,
    v.INSTANCE_ID,
    v.MODULE AS application,
    v.PROGRAM AS backend_app,
    v.SQL_OPNAME AS sql_op,
    h.MACHINE AS node
FROM
    (
        SELECT
            s.SQL_ID,
            MIN(s.FIRST_LOAD_TIME) AS START_TIME,
            MAX(s.LAST_LOAD_TIME) AS END_TIME,
            s.INSTANCE_NUMBER AS INSTANCE_ID,
            s.MODULE,
            s.PROGRAM,
            s.SQL_OPNAME
        FROM
            v$sql s
        JOIN
            v$session sess ON s.SQL_ID = sess.SQL_ID
        WHERE
            s.FIRST_LOAD_TIME IS NOT NULL
            AND s.LAST_LOAD_TIME IS NOT NULL
            AND s.LAST_LOAD_TIME > SYSDATE - INTERVAL '30' MINUTE -- Adjust the time threshold as needed
        GROUP BY
            s.SQL_ID,
            s.INSTANCE_NUMBER,
            s.MODULE,
            s.PROGRAM,
            s.SQL_OPNAME
    ) v
JOIN
    dba_hist_active_sess_history h ON v.SQL_ID = h.SQL_ID
ORDER BY
    v.END_TIME DESC;
