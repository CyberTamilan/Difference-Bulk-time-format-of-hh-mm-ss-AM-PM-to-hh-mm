WITH query_stats AS (
    SELECT s.program AS application_name,
           s.sql_id AS sql_id,
           TO_CHAR(s.sql_exec_start, 'YYYY-MM-DD HH24:MI:SS') AS start_time,
           TO_CHAR(s.sql_exec_start + (s.elapsed_time / 1000000 / 86400), 'YYYY-MM-DD HH24:MI:SS') AS end_time,
           s.elapsed_time / 1000000 AS elapsed_seconds,
           s.sql_fulltext AS sql_text
    FROM v$sql s
    JOIN v$session sess ON s.sql_id = sess.sql_id
    WHERE s.elapsed_time > (30 * 60 * 1000000) -- 30 minutes in microseconds
),
hostname_query AS (
    SELECT sys_context('USERENV', 'SERVER_HOST') AS hostname
    FROM dual
)
SELECT qs.application_name,
       qs.sql_id,
       qs.start_time,
       qs.end_time,
       qs.elapsed_seconds,
       COUNT(*) AS num_times_triggered,
       CASE
           WHEN COUNT(*) >= 30 THEN 'Daily'
           WHEN COUNT(*) >= 7 THEN 'Weekly'
           ELSE 'Monthly'
       END AS trigger_frequency,
       h.hostname,
       ash.INSTANCE_NUMBER
FROM query_stats qs
CROSS JOIN hostname_query h
JOIN v$active_session_history ash ON qs.sql_id = ash.SQL_ID
GROUP BY qs.application_name, qs.sql_id, qs.start_time, qs.end_time, qs.elapsed_seconds, h.hostname, ash.INSTANCE_NUMBER
ORDER BY qs.elapsed_seconds DESC;
